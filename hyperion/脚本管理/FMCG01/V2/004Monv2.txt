ESS_LOCALE SimplifiedChinese_China.MS936@Binary

SET UPDATECALC OFF;
SET AGGMISSG ON;
SET CREATENONMISSINGBLK OFF; 


维度总量 19个
其中CDD01-CDD06为备用维度尚未启用
密集维：AccountValueView
稀疏维：PeriodEntityProductlineProductChannelCustomerRegionVersionScenarioYears

FIX (&CurYr, Actual,Working,no_CDD01,no_CDD02,no_CDD03,no_CDD04,no_CDD05,no_CDD06) (9)

	FIX(Amount ,@RELATIVE(Entity,0))(11)	
	
		对分摊因子进行聚合：销售收入,销售成本,产量,销量	
		FIX(销售收入,销售成本,销量,Before_Allc)(13)					
			AGG(Product);
			AGG(ProductLine);
			AGG(Channel);
			AGG(Customer);
			AGG(Region);
			AGG(Period);
		ENDFIX
		
		将销量,销售收入,销售成本的“Before_Allc”数据copy到“Orig”
		FIX(@RELATIVE(Product,0),@RELATIVE(ProductLine,0))(13)
			FIX(@IDESC(&PreMon),@RELATIVE(Customer,0),@RELATIVE(Region,0),@RELATIVE(Channel,0),销售收入,销售成本,销量)(18)
				DATACOPY Before_Allc TO Orig;
			ENDFIX
		
			将产量等的“Before_Allc”数据copy到“Orig”		
			FIX(no_Channel,no_Customer,no_Region,产量)(17)
				FIX (Before_Allc)(18)				
					AGG(Period);
				ENDFIX
				FIX(@IDESC(&PreMon))(18)
					DATACOPY Before_Allc TO Orig;
				ENDFIX	
			ENDFIX	
			
			FIX(no_Channel,no_Customer,no_Region,肉类成本,米面成本,蔬菜成本,其他原料成本,辅料成本,包装成本,原料成本,制造费用,直接人工,直接水费,直接电费,直接维修,直接物料消耗,直接蒸汽,直接天然气,直接折旧,直接其他,间接人工,间接水费,间接电费,间接维修,间接物料消耗,间接蒸汽,间接天然气,间接折旧,间接其他)
				FIX(&PreMon)(18)
					DATACOPY Before_Allc TO Orig;
				ENDFIX	
			ENDFIX
		ENDFIX
				
	ENDFIX
	
	工厂成本单位总额计算	
	先根据接口月总额计算月单位：月单位=接口月总额月产量总额
	只在有产量的日子计算日单位及日总额
	日单位=月单位=接口月总额月产量总额
	日总额=日单位日产量
	日总额聚合到月总额
	FIX(@RELATIVE(Product,0),@RELATIVE(ProductLine,0),no_Channel,no_Customer,no_Region,@RELATIVE(Entity,0))(15)	
		FIX(肉类成本,米面成本,蔬菜成本,其他原料成本,辅料成本,包装成本,原料成本,制造费用,直接人工,直接水费,直接电费,直接维修,直接物料消耗,直接蒸汽,直接天然气,直接折旧,直接其他,间接人工,间接水费,间接电费,间接维修,间接物料消耗,间接蒸汽,间接天然气,间接折旧,间接其他)(16)
			单位生产成本=总额产量，月		
			FIX(&PreMon,Per_Unit)(18)
				Orig=Amount-Before_Allc产量-Amount-Before_Allc;
			ENDFIX	
			
			FIX(@RELATIVE(&PreMon,0))(17)
				FIX(Per_Unit)(18)
					Orig
					(
						IF(产量-Amount #MISSING)
							Orig=@PARENT(Period);
						ENDIF
					)	
				ENDFIX
				
				日总额=单位生产成本产量（如有）	
				FIX(Orig)(18)
					Amount
					(
						IF(产量-Amount #MISSING)
							Amount = Per_Unit  产量-no_Channel-no_Customer-no_Region-Amount;
						ENDIF
					)
				ENDFIX				
			ENDFIX
			
			FIX(Amount,Orig) (18)
			@IDESC(YearTotal);
			ENDFIX	
		ENDFIX
	ENDFIX
	

	FIX(@RELATIVE(Product,0),@RELATIVE(ProductLine,0),@RELATIVE(Customer,0),@RELATIVE(Region,0),@RELATIVE(Channel,0),@RELATIVE(Entity,0))(15)
	
		销售成本调整项根据销售成本占比分摊到各SKU上，数据存储在销售成本调整项-Orig上。最终Orig上销售成本合计=销售成本+销售成本调整项（大纲动态计算）
		先计算日总额，再算日单位；日总额聚合到月总额，再算日单位
		单位值用大纲Per_Unit00直接计算
		FIX(@RELATIVE(&PreMon,0),Orig)(17)
			FIX(Amount) (18)		
				销售成本调整项=销售成本-Before_Allc销售成本-Before_Allc-All_Customer-All_ProductLine-All_Region-All_Channel-All_Product-@PARENT(Period)销售成本调整项-no_Customer-no_Region-no_ProductLine-no_Channel-no_Product-Before_Allc-@PARENT(Period);
			ENDFIX			
		ENDFIX
		
		销售成本调整项日数据聚合到月总量
		FIX(Amount,Orig,销售成本调整项) (18)
			@IDESC(YearTotal);	
		ENDFIX
		

		根据销售收入占比对管、财费用相关科目进行分摊（不含跌价准备）
		根据销售收入占比对税金及附加,管理费用,管理费用-折旧费用,管理费用-薪资及附加,管理费用-工会经费,财务费用,财务费用-利息支出,财务费用-利息收入,财务费用-银行手续费,财务费用-财务服务费,财务费用-汇兑损益,财务费用-锁定利率,其他业务利润,营业外收支,技术服务费,锁汇资金占用进行分摊
		上月Orig月费用按本月天数均摊到本月每日Orig，之后按销售收入占比做分摊
		日总额聚合到月总额，再算月单位
		单位值用大纲Per_Unit00直接计算
		FIX(税金及附加,管理费用,管理费用-折旧费用,管理费用-薪资及附加,管理费用-工会经费,财务费用,财务费用-利息支出,财务费用-利息收入,财务费用-银行手续费,财务费用-财务服务费,其他业务利润,营业外收支,技术服务费,所得税,财务费用-汇兑损益,财务费用-锁定利率,锁汇资金占用)	(16)	
			FIX(@RELATIVE(&PreMon,0))(17)	
				FIX(Amount)(18)	
					Orig=Before_Allc-@PARENT(Period)-no_Product-no_ProductLine-no_Channel-no_Region-no_CustomerDays-预算-no_Product-no_ProductLine-no_Channel-no_Region-no_Customer-no_Entity-@PARENT(Period)销售收入-Before_Allc销售收入-All_Customer-All_ProductLine-All_Region-All_Channel-All_Product-Before_Allc-@PARENT(Period);
				ENDFIX
			ENDFIX
			
			相关日数据聚合到月总量		
			FIX(orig,Amount)18
				@IDESC(YearTotal);
			ENDFIX
		ENDFIX
		
		根据销售收入占比对销售费用,销售费用-运输费用,销售费用-样品费用,销售费用-品牌使用费进行分摊
		与管财费用不同，不需要先将月总额均摊到日后再分摊，直接按销售收入占比分摊
		先算日总额，再算日单位
		日总额聚合到月总额，再算月单位
		单位值用大纲Per_Unit00直接计算
		FIX(销售费用,销售费用-运输费用,销售费用-样品费用,销售费用-品牌使用费)(16)
			FIX(@RELATIVE(&PreMon,0))(17)	
				FIX(Amount)(18)	
					Orig=Before_Allc-@PARENT(Period)-no_Product-no_ProductLine-no_Channel-no_Region-no_Customer销售收入-Before_Allc销售收入-All_Customer-All_ProductLine-All_Region-All_Channel-All_Product-Before_Allc-@PARENT(Period);
				ENDFIX
			ENDFIX
			
			相关日数据聚合到月总量		
			FIX(orig,Amount)18
				@IDESC(YearTotal);
			ENDFIX
		ENDFIX
		
		销售成本 单位=总额销量 日总量数据直接接口进入，单位数据大纲Per_Unit00计算 
		FIX(销售成本,销售收入)(16)
		相关日数据聚合到月总量		
			FIX(Orig,Amount)18
				@IDESC(YearTotal);
			ENDFIX
		ENDFIX

		单位=总额产量 日月 
		产销成本差异=单位生产成本销量-销售成本合计
		先算月总额，再算月单位。根据月单位得出日总额，再算日单位。
		单位值用大纲Per_Unit00直接计算
		FIX(&PreMon,Orig)(17)
			FIX(Amount)(18)
				产销成本差异=生产成本 - 销售成本合计;
			ENDFIX
		ENDFIX
		
		FIX(@RELATIVE(&PreMon,0),Orig)(17)
			FIX(Amount)(18)
				产销成本差异=产销成本差异-@PARENT(Period)销量-@PARENT(Period) 销量;
			ENDFIX
		ENDFIX
		


		边际贡献=销售收入-Amount销量-Amount -原料成本 -辅料成本 -包装成本-变动制造费用-销售费用 只计有销售收入的
		1、日：先计算单位边际贡献，再计算总额=单位边际贡献销量
		2、月：先计算总额=日的聚合，再计算单位边际贡献=月总额销量
		
		FIX(@RELATIVE(&PreMon,0),Orig)(17)
		  FIX(Per_Unit)(18)
		 边际贡献
			(
				IF(销售收入-Amount #MISSING)
						边际贡献=销售收入-Amount销量-Amount-原料成本-@PARENT(Period)-no_Channel-no_Customer-no_Region -辅料成本-@PARENT(Period)-no_Channel-no_Customer-no_Region -包装成本-@PARENT(Period)-no_Channel-no_Customer-no_Region-变动制造费用-@PARENT(Period)-no_Channel-no_Customer-no_Region-销售费用-@PARENT(Period)-no_Channel-no_Customer-no_Region销量-@PARENT(Period)-all_Channel-all_Customer-all_Region -all_ProductLine-all_Product;
				ENDIF
			)
			ENDFIX
			
			FIX(Amount)(18)
				边际贡献=边际贡献-Per_Unit销量;
			ENDFIX
		ENDFIX
		
		FIX(边际贡献,Orig)(17)
		相关日数据聚合到月总量		
			FIX(Amount)18
				@IDESC(YearTotal);
			ENDFIX
			
		月单位边际贡献=月总额月销量	
			FIX(&PreMon)(18)
				Per_Unit=Amount销量-Amount;
			ENDFIX	
			
		ENDFIX
		
		跌价准备按照销售收入比例分摊
		FIX(管理费用-跌价准备)(16)	
			FIX(@RELATIVE(&PreMon,0))(17)	
				FIX(Amount)(18)	
					Orig =销售收入-Before_Allc销售收入-Before_Allc-All_Channel-All_Product-All_Region-All_Customer-@PARENT(Period)Before_Allc-no_Channel-no_Customer-no_Region-@PARENT(Period);
				ENDFIX
			ENDFIX
			
			FIX(Amount,Orig)18
				@IDESC(YearTotal);
			ENDFIX
		ENDFIX
	ENDFIX
		

各维度大聚合,单位=总额销量
	FIX(@IDESC(Yeartotal),@RELATIVE(AF_P&L,0),@RELATIVE(Quantity,0),其他业务利润,营业外收支,技术服务费,销售费用-运输费用,销售费用-样品费用,销售费用-品牌使用费,管理费用-折旧费用,管理费用-薪资及附加,管理费用-工会经费,财务费用-利息支出,财务费用-利息收入,财务费用-银行手续费,财务费用-财务服务费,产销成本差异,边际贡献,税金及附加,肉类成本,米面成本,蔬菜成本,其他原料成本,辅料成本,包装成本,原料成本,制造费用,直接人工,直接水费,直接电费,直接维修,直接物料消耗,直接蒸汽,直接天然气,直接折旧,直接其他,间接人工,间接水费,间接电费,间接维修,间接物料消耗,间接蒸汽,间接天然气,间接折旧,间接其他,财务费用-汇兑损益,财务费用-锁定利率,所得税,锁汇资金占用,管理费用-跌价准备)(11)			
		FIX(Amount,Orig)(13)
			AGG(Entity);
			AGG(Product);
			AGG(Channel);
			AGG(Customer);
			AGG(Region);
			AGG(ProductLine);
		ENDFIX
	ENDFIX
	FIX(@IDESC(Yeartotal),肉类成本,米面成本,蔬菜成本,其他原料成本,辅料成本,包装成本,原料成本,制造费用,直接人工,直接水费,直接电费,直接维修,直接物料消耗,直接蒸汽,直接天然气,直接折旧,直接其他,间接人工,间接水费,间接电费,间接维修,间接物料消耗,间接蒸汽,间接天然气,间接折旧,间接其他)(11)
		FIX(Per_Unit,@IDESC(Total_Product),@IDESC(Total_ProductLine),@RELATIVE(Entity,0),@IDESC(Total_Channel),@IDESC(Total_Region),@IDESC(Total_Customer))(18)
				Orig=Amount产量-no_Channel-no_Customer-no_Region-Amount;
		ENDFIX
	ENDFIX		

ENDFIX

